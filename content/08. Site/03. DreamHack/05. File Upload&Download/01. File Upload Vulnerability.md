
# 1. Path Traversal
파일 업로드를 허용하는 대개의 서비스는 보안을 위해 특정 디렉터리에만 업로드를 허용합니다. 만약 이러한 제한이 없다면, 악의적인 이용자가 웹 서버의 소스 코드나 서버에 있는 중요 시스템 파일을 덮어 쓸 위험이 있습니다. Path Traversal 취약점은 업로드에 존재하는 이러한 제약을 우회하여, 임의 디렉터리에 파일을 업로드할 수 있는 취약점을 말합니다.

# 2. 악성 파일 업로드
이용자가 파일을 업로드할 때, 이를 제대로 검사하지 않아서 발생하는 취약점을 말합니다.

## 웹 셸

**웹 서버**는 `.php`, `.jsp`, `.asp`와 같은 확장자의 파일을 **Common Gateway Interface(CGI)** 로 실행하고, 그 결과를 이용자에게 반환합니다.  **Figure 6** 은 이용자가 요청한 파일의 확장자가 정규표현식 `".+\.ph(p[3457]?|t|tml)$"`를 만족하면, `x-httpd-php`로 핸들링하게 하는 Apache 설정 파일입니다. `x-httpd-php`는 PHP 엔진이며 요청한 파일을 실행하고, 그 결과를 반환합니다. `.php`, `.php3`, `.phtml`이 위의 정규표현식을 만족합니다.

|**Figure 6. Apache 설정 파일**|
|---|
|<FilesMatch ".+\\.ph(p[3457]?\|t\|tml)$"> <br>   &nbsp;&nbsp;SetHandler application/x-httpd-php <br><\/FilesMatch>|

많은 웹 서버들이 `php`파일에 대해 위와 같은 핸들링을 지원합니다. 따라서 공격자가 임의의 `php` 소스 파일을 `.php` 확장자로 업로드하고, GET 요청을 보낼 수 있다면 CGI에 의해 해당 코드가 실행되도록 할 수 있습니다.

|**💡Common Gateway Interface(CGI)란?**|
|---|
|_요즘 시대에는 정적인 웹 페이지만 제공하는 웹 애플리케이션은 거의 찾아보기 힘듭니다. 동적인 컨텐츠를 처리하기 위해서 웹 서버와 php 같은 외부의 프로그램에 사이에서 인터페이스를 제공하는 프로토콜이 CGI입니다._|

이 CGI는 WAS와 비슷하다고 볼 수 있다.

**CGI  특징**
- CGI는 가장 오래된 인터페이스이고, 거의 모든 웹서버를 지원 가능.
- CGI를 구동하는 방법이 한가지는 아니지만, 대표적인 방법이 Apache HTTPd.
- 웹서버와 통신하기 위해 CGI를 사용하는 프로그램은 매 리퀘스트마다 서버를 재시작해야 함.

**Reference**
* 아파치에서 파이썬 cgi실행 방법 https://wikidocs.net/129281 


# 3. 악의적인 웹 리소스

**웹 브라우저**는 파일의 확장자나 응답의 `Content-Type`에 따라 요청을 다양하게 처리합니다. 만약 요청한 파일의 확장자가 `.html` 이거나, 반환된 `Content-Type` 헤더가 `text/html`일 경우 응답은 HTML 엔진으로 처리됩니다. 또, 파일의 확장자가 `.png`, `.jpg`등의 이미지 확장자이거나, `Content-Type`이 `image/png`일 경우에는 이미지로 렌더링됩니다.

만약 공격자가 서버에 `exploit.html`을 업로드하고, 이에 접근하는 URL이 `https://dreamhack.io/uploads/exploit.html`이라면, 브라우저는 이를 HTML로 해석됩니다. `exploit.html`에 악의적인 스크립트를 삽입하면, Cross-Site-Scripting (XSS) 공격으로 이어질 수 있습니다.


# 4. 대응방안

업로드 취약점을 막으려면 개발자는 업로드 디렉터리를 웹 서버에서 직접 접근할 수 없도록 하거나, 업로드 디렉터리에서는 CGI가 실행되지 않도록 해야 하고 업로드된 파일 이름을 그대로 사용하지 않고 `basepath`와 같은 함수를 통해 파일 이름을 검증한 후 사용해야 합니다. 또한 허용할 확장자를 명시해 그 외 확장자는 업로드될 수 없도록 해야 합니다.

또 다른 방법은 AWS, Azure, GCP 등의 정적 스토리지를 이용하는 것입니다. 서버의 파일 시스템을 이용하지 않기 때문에 파일 업로드 취약점이 웹 서버 공격으로 이어지는 것을 예방할 수 있습니다.