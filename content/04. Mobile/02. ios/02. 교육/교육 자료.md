
# 1. ios 탈옥

## 1.1 ios 탈옥(jailbreak) 이란?

 > **루트 권한을 얻는 것** 

- jail = 교도소 + break = 탈옥 
- iPhone 'lock down mobile device' 

## 1.2 ios 탈옥(jailbreak)을 하는 이유(공격자가)? 

> **App Hacking** 

* Tool을 설치하여 정상적인 앱 동작을 우회하여 이익(정보, 금전, 즐거움)을 얻기 위함

## 1.3 ios 탈옥 작동원리  

> **/private/etc/fstab 패치**   

- fstab은 루트 및 미디어 파티션에 대한 권한을 제어하는 ​​스위치 역할이다. 
- fstab은 기본적으로 'read-only' ,  'read-write'로 변경 해줘야함.


**ios 부팅 프로세스**

Apple 장치가 부팅될 때마다 "trust-chain"이라는 과정을 거친다. 이는 기본적으로 실행 중인 모든 항목이 Apple에서 승인한 것인지 확인하는 일련의 검사 과정

일반적인 순서 
* **Bootrom 실행**: Apple에서는 "SecureROM"이라고도 하며, iDevice에서 실행되는 첫 번째 중요한 코드
* **부트로더 실행**: 일반적으로 메인 펌웨어 로드를 담당 
* **커널 로드**: iOS와 하드웨어 수준에서 수행되는 실제 데이터 처리 사이를 연결 
* **iOS 로드**: 체인의 마지막 단계인 iOS가 시작되고 "슬라이드하여 잠금 해제" 보기가 표시  

커널이 로드되는 동안 모든 것이 Apple 승인을 받아 로드 되었는지 확인하기 위해 수천 가지 테스트가 수행된다. 부팅 프로세스 전반에 걸쳐 서명이나 키를 찾는 많은 검사가 존재한다.


**Apple의 검사 과정을 우회하는 방법**

수천개의 검사를 패치 or 우회 하는 것

- **bootrom Exploit**: 부트롬 중에 Exploit이 수행된다. 기존 펌웨어 업데이트로는 패치할 수 없으며 새로운 하드웨어로 패치해야 한다. 거의 모든 체크포인트 이전이기 때문에 악성코드가 모든 것보다 먼저 주입되어 모든 체크를 우회하거나 단순히 비활성화할 수 있는 통로가 생성될 수 있다.
- **userland Exploit**: 커널이 로드되는 동안이나 이후에 악용이 이루어진다. Apple에서 소프트웨어 업데이트를 통해 쉽게 패치할 수 있다. 모든 검사가 완료되었으므로 악성 코드를 커널의 열린 부분에 직접 주입한다. 이러한 틈은 찾기가 쉽지 않으며 일단 발견되면 패치 할 수 있다.  

**Palera1n은 어떤 방식?**
checkm8 bootROM 익스플로잇(CVE-2019-8900) 을 활용하여 iOS 15.0-16.5에서 arm64(arm64e 제외)가 있는 모든 iOS/iPadOS 장치를 탈옥


> reference 
> https://www.appknox.com/blog/how-does-jailbreak-work
> https://cdn.nickchan.lol/palera1n/c-rewrite/releases/v2.0.0-beta.7/palera1n.1.html
> https://www.theiphonewiki.com/wiki/Checkm8_Exploit
# 2. IPA 파일 추출
## 2.1 IPA(IOS App Store Pakage) 란? 

> IOS 애플리케이션을 저장하는 아카이브(Zip 압축을 사용한 압축) 파일

```
// IPA 파일 구조 

/Payload/ 
/Payload/Application.app/ 
/iTunesArtwork 
/iTunesArtwork@2x 
/iTunesMetadata.plist 
/WatchKitSupport/WK 
/META-INF
```

- 위의 내용은 iTunes와 App Store가 인식할 수 있도록 내장된 구조
- Payload 디렉토리에는 모든 앱 데이터가 포함

## 2.2 IPA파일을 추출하는 이유? 

> 바이너리 파일 분석 

## 2.3 frida-ios-dump를 사용하는 이유?

>  복호화 된 바이너리를 가져오기 위해 

- 앱 스토어에 업로드 되지 않은 IPA파일은 암호화가 적용되어 있지 않기 때문에 복호화 없이 추출 가능 하다.
- 앱 스토어에서 다운로드한 앱은 **FairPlay DRM**을 이용해 암호화되어 보호된다. 
- 단말기에서 앱 실행시 암호화된 바이너리 파일은 커널의 Mach-O 로더에 의해 **런타임 중 복호화**된다. 이 런타임 중의 복호화 과정 전체를 특정도구(frida-ios-dump)로 덤프 떠 복호화된 바이너리 내용을 확인 할 수 있다.

# 3. 소스코드 분석 

## 3.1 정적분석(Satatic Analysis)이란? 

> 소스코드 실행 없이 정적으로 프로그램을 분석 하는 것 

## 3.2 정적분석(Satatic Analysis)하는 이유? 

> 탈옥탐지 우회 

- 잠재적인 취약점 및 버그 발견 

>reperence
>https://en.fasoo.com/blog/top-10-reasons-why-you-should-use-static-code-analysis/

## 3.3 IDA 란? 

> **I**nteractive **D**is**A**ssembler, 디스어셈블러 

- hex-rays사에서 개발 
- **바이너리 >> 어셈블리어 >> 프로그래밍 언어** 까지 번역

## 3.3 Ghidra 란? 

> NSA에서 개발한 리버스 엔지니어링 도구 

- Ghidra는 국가 안보국(National Security Agency)내에서 개발된 많은 오픈 소스 소프트웨어(OSS) 프로젝트 중 하나
- 2019년 출시 

> reference
> https://ghidra-sre.org/
> https://hex-rays.com/ida-free/


## 3.4 IDA와 Ghidra 차이 



# 4. OS 변조 탐지 기능 적용 여부(탈옥탐지 우회)
## 4.1 OS 변조 탐지? 

> 탈옥 탐지

## 4.2 바이너리 파일 변조

> HEX파일(16진수 ASCII파일)로 변환된 바이너리파일을 변조

- 바이너리파일(이진파일)은 텍스트에디터로 편집이 안됨,
- 파이썬으로 이진파일 수정방법 (https://gr-st-dev.tistory.com/1762)

## 4.3 프리다 후킹(Frida Hooking)

**프리다(Frida) 란?**

> 동적 코드 분석 도구 

- Core 부분 은 C로 작성, 대다수 구현체는 python
- js, c, swift 등 여러 언어를 지원

**프리다(Frida) 동작원리**

- **Quick JS**를 Target Process에 주입하여 JavaScript가 메모리에 완전한 액세스 권한을 가지고 함수 후킹 및 프로세스 내에서 native 함수 호출까지 실행 가능.
- 앱과 Process 내에서 실행되는 JS 간의 양방향 통신채널을 통해 동적 분석이 가능하다. 


>reference 
>https://frida.re/docs/home/
>https://bellard.org/quickjs/

# 5. 메모리 내 중요정보 노출 여부(메모리 덤프)
## 5.1 메모리란? 
## 5.2 어떻게 개발을 했을때 메모리에 정보가 남는가?  
## 5.3 메모리 덤프를 가져오는 방식은?

# 6. 프로그램 무결성 검증(무결성 탐지 우회)
## 6.1 무결성이란? 

## 6.2 무결성 탐지 방식의 종류 


**해시 함수(Hash Function)란?**

> 임의의 길이의 데이터를 입력으로 받아 고정된 길이의 데이터로 출력하는 함수

- 예를들어 해시 함수의 대표적인 예인 SHA256 함수는 임의의 길이의 데이터를 256비트의 데이터로 출력
- 해시 함수에 의해 출력되는 값을 **해시 값(Hash value)** , **해시 코드(Hash code)** 또는 **해시(hash)** 라 부른다

> reference
> https://wikidocs.net/78544

## 6.3 무결성 탐지 우회의 종류 

# 7. 디버그 로그 내 중요정보 노출 
# 8. 디버깅 탐지 기능 적용 
 
