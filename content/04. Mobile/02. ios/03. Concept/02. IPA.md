
# 1. IPA 파일 구조

```
/Payload/ 
/Payload/Application.app/ 
/iTunesArtwork 
/iTunesArtwork@2x 
/iTunesMetadata.plist 
/WatchKitSupport/WK 
/META-INF
```

위의 내용은 iTunes와 App Store가 인식할 수 있도록 내장된 구조입니다. 이 구조에 따라:

- Payload 디렉토리에는 모든 앱 데이터가 포함됩니다.
- iTunes Artwork 파일은 512×512 픽셀 PNG 이미지로, iTunes 및 iPad의 App Store 앱에 표시하기 위한 앱 아이콘이 포함되어 있습니다.
- iTunesMetadata.plist에는 개발자 이름 및 ID, 저작권 정보, 번들 식별자, 앱 이름, 장르, 출시 날짜, 구매 날짜 등 다양한 정보가 포함되어 있습니다.
- META-INF 폴더에는 IPA를 생성하는 데 사용된 프로그램에 대한 메타데이터만 포함됩니다.

> reperence 
> https://en.wikipedia.org/wiki/.ipa


# 2. 암호화 

# 2.1 앱스토어에 업로드 되지 않은 IPA 파일 

앱 스토어에 업로드 되지 않은 IPA파일은 암호화가 적용되어 있지 않기 때문에 복호화를 거치지 않고 ipainstaller 라는 프로그램으로 바로 추출해도 분석이 가능하다.

```
ipainstaller -b [번들 아이디]
```

## 2.2 앱스토어에 업로드 된 IPA 파일 

앱 스토어에서 다운로드한 앱은 FairPlay DRM을 이용해 암호화되어 보호된다. 또한 암호화된 바이너리 파일은 커널의 Mach-O 로더에 의해 런타임 중 해독된다.


**Mach-O(Mach Object file format) 파일 이란? 

> Mach 커널을 기반으로 하는 시스템 (ios, MacOS) 에서 사용하는 실행 파일 포맷 

- Mach-O(Mach Object file format) (마크 - 오 또는 마하 - 오 )
- ios는 이 Mach-O 바이너리 파일을 실행하여 앱을 구동한다. 
- /Payload/sammple.app/info.plist에서  **Executable file** 에 있는 항목이 앱이 실행될때 가장먼저 실행되는 Mach-O 파일이다.  (어떤 파일은 CFBundleExecutable로 적혀있다. )


> reference 
> https://engineering.linecorp.com/ko/blog/ios-code-signing

**Fairplay DRM 이란? 

> 애플사의  DRM(Digital Rights Management) 규격



**DRM 복호화 원리**

단말기에서 앱 실행시 암호화된 바이너리 파일은 커널의 Mach-O 로더에 의해 **런타임 중 복호화**
이 런타임 중의 복호화 과정 전체를 특정도구 (frida-ios-dump)로 덤프 떠 복호화된 바이너리 내용을 고스란히 확인 할 수 있다. 


**Fairplay DRM 적용여부 확인법 

putty로 iOS 기기에 원격 접속 후, otool 이라는 도구를 사용하여 확인한다.
결과에서 cryptid 가 0이라면 Fairplay 적용되지 않은 상태, 1이라면 Fairplay가 적용된 상태이다.

```
# 앱 저장 위치로 이동
cd /var/containers/Bundle/Application/$uuid/Application.app

# otool를 사용하여 확인 otool -l [Application name] | grep -A4 LC_ENCRYPTION_INFO 

# 결과 예시
cmd LC_ENCRYPTION_INFO_64
cmdsize 24 
cryptoff 16384 
cryptsize 3801088 
cryptid 0

```


>reperence
>https://www.dongyeon1201.kr/52b65a53-acd9-4f58-b958-ea3740125ea4



